{#include base}
    {#title}{campaign.name} - Ironsworn{/title}
    {#header}{/header}

    {#stylesheets}
    <link rel="stylesheet" href="/play.css">
    {/stylesheets}

    {#scripts}
    <script src="/play-interface.js"></script>
    {/scripts}

    {#nav}
    <nav>
        <a href="/">Home</a>
        <a href="/play">‚öîÔ∏è Play</a>
        <a href="/campaign/{campaign.id}">üí¨ Campaign Q&A</a>
        <a href="/reference" target="_blank">üìñ Reference</a>
    </nav>
    <script>
        document.querySelectorAll('nav a').forEach(a => {
            const path = window.location.pathname;
            const href = a.getAttribute('href');
            if (href === '/' ? path === '/' : path.startsWith(href)) {
                a.classList.add('active');
            }
        });
    </script>
    {/nav}

    {#mainClass}class="play-area"{/mainClass}

    {#content}
    <!-- Character header bar (always visible) -->
    <div id="character-bar">
        <span id="char-name-display" class="char-name"></span>
        <div class="stat-buttons">
            <button class="stat-btn" data-stat="edge">Edge <span id="stat-edge">0</span></button>
            <button class="stat-btn" data-stat="heart">Heart <span id="stat-heart">0</span></button>
            <button class="stat-btn" data-stat="iron">Iron <span id="stat-iron">0</span></button>
            <button class="stat-btn" data-stat="shadow">Shadow <span id="stat-shadow">0</span></button>
            <button class="stat-btn" data-stat="wits">Wits <span id="stat-wits">0</span></button>
        </div>
        <div class="meters">
            <label class="meter" title="Health">&#x2764; <input type="number" id="meter-health" min="0" max="5" value="5"></label>
            <label class="meter" title="Spirit">&#x2728; <input type="number" id="meter-spirit" min="0" max="5" value="5"></label>
            <label class="meter" title="Supply">&#x1F392; <input type="number" id="meter-supply" min="0" max="5" value="5"></label>
            <label class="meter" title="Momentum">&#x26A1; <input type="number" id="meter-momentum" min="-6" max="10" value="2"></label>
        </div>
    </div>

    <!-- Scene context bar -->
    <div id="scene-bar">
        <span id="scene-location"></span>
        <span id="scene-npcs"></span>
    </div>

    <!-- Main layout -->
    <div id="play-layout">
        <!-- Narrative chat (primary) -->
        <div id="narrative-area">
            <div id="chat-messages"></div>

            <div id="input-container">
                <!-- Move badge (hidden until move selected) -->
                <div id="move-badge" class="hidden">
                    <span id="roll-move-name"></span>
                    <span id="roll-stat-prompt">Select a stat</span>
                    <label class="adds-input" title="Situational modifier (+1, +2, etc.)">
                        <span>+</span><input type="number" id="roll-adds" min="0" max="9" value="0">
                    </label>
                    <button id="roll-cancel" title="Cancel move">&times;</button>
                </div>
                <textarea
                    id="message-input"
                    placeholder="What do you do?"
                    autocomplete="off"
                    rows="1"></textarea>
                <div id="input-actions">
                    <button id="inspire-btn" title="What happens next? (Oracle-driven inspiration)">&#x1F3B2; Inspire</button>
                    <button id="send-btn">Send</button>
                    <!-- Roll controls (hidden until move selected) -->
                    <div id="roll-controls" class="hidden">
                        <button id="roll-btn" class="btn-primary" disabled>Roll</button>
                        <label class="manual-toggle">
                            <input type="checkbox" id="manual-dice-toggle"> Dice
                        </label>
                    </div>
                </div>
                <div id="manual-dice" class="hidden">
                    <label>Action (d6) <input type="number" id="dice-action" min="1" max="6"></label>
                    <label>C1 (d10) <input type="number" id="dice-c1" min="1" max="10"></label>
                    <label>C2 (d10) <input type="number" id="dice-c2" min="1" max="10"></label>
                </div>
                <!-- Momentum burn prompt (shown dynamically) -->
                <div id="momentum-burn" class="hidden">
                    <div id="burn-comparison"></div>
                    <button id="burn-btn">Burn Momentum</button>
                    <button id="skip-burn-btn">Keep Result</button>
                </div>
                <!-- Backtrack confirm bar (shown in backtrack mode) -->
                <div id="backtrack-confirm" class="hidden">
                    <span id="backtrack-count">Select a message to backtrack to</span>
                    <button id="backtrack-confirm-btn" disabled>Delete</button>
                    <button id="backtrack-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Sidebar (moves + oracles + vows) -->
        <aside id="sidebar">
            <button id="backtrack-btn" title="Backtrack ‚Äî remove recent messages">&#x23EA; Backtrack</button>

            <div id="vows-section">
                <h2>Vows</h2>
                <div id="vows-list"></div>
            </div>

            <div id="moves-section">
                <h2>Moves</h2>
                {#for entry in moves.entrySet()}
                <details class="move-category">
                    <summary>{entry.value.name.value}</summary>
                    {#if entry.value.contents != null}
                    {#for move in entry.value.contents.entrySet()}
                    <button class="move-btn{#if move.value.rollType eq 'progress_roll'} progress-move{#else if move.value.rollType eq 'no_roll'} no-roll-move{/if}"
                            data-category="{entry.key}"
                            data-move="{move.key}"
                            data-move-name="{move.value.name.value}"
                            data-roll-type="{move.value.rollType}"
                            {#if move.value.rollType eq 'no_roll'}disabled{/if}>
                        {util:mdToHtml(move.value.name.value, true)}
                    </button>
                    {/for}
                    {/if}
                </details>
                {/for}
            </div>

            <div id="oracles-section">
                <h2>Oracles</h2>
                {#for entry in oracles.entrySet()}
                <details class="oracle-category">
                    <summary>{entry.value.name.value}</summary>
                    {#if entry.value.contents != null}
                    {#for table in entry.value.contents.entrySet()}
                    <button class="oracle-btn"
                            data-collection="{entry.key}"
                            data-table="{table.key}">
                        {util:mdToHtml(table.value.name.value, true)}
                    </button>
                    {/for}
                    {/if}
                </details>
                {/for}
            </div>
        </aside>
    </div>

    <!-- Bottom drawer toggle (narrow screens) -->
    <button id="drawer-toggle" title="Moves &amp; Oracles">&#9776;</button>
    {/content}

    {#footer-scripts}
    <script>
        new PlayInterface({
            campaignId: '{campaign.id}',
            wsUrl: 'ws://' + window.location.host + '/ws/play/{campaign.id}'
        });
    </script>
    {/footer-scripts}
{/include}
